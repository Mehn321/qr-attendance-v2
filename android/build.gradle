// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
  repositories {
    google()
    mavenCentral()
  }
  dependencies {
    classpath('com.android.tools.build:gradle')
    classpath('com.facebook.react:react-native-gradle-plugin')
    classpath('org.jetbrains.kotlin:kotlin-gradle-plugin')
  }
}

// ========== GLOBAL JVM VERSION SETTING ==========
// Must be set BEFORE plugin application
ext.javaVersion = JavaVersion.VERSION_17

allprojects {
  repositories {
    google()
    mavenCentral()
    maven { url 'https://www.jitpack.io' }
  }
  
  // Apply EARLY to prevent module override
  configurations.all {
    resolutionStrategy {
      // Force consistent compilation across all tasks
      eachDependency { DependencyResolveDetails details ->
        // This ensures dependency compatibility
      }
    }
  }
}

apply plugin: "expo-root-project"
apply plugin: "com.facebook.react.rootproject"

// ========== AGGRESSIVE JVM 11 ENFORCEMENT ==========
// This runs IMMEDIATELY after all projects load
subprojects { project ->
  // Apply BEFORE evaluation - prevents module override
  beforeEvaluate {
    if (project.hasProperty('android')) {
      // Set android.compileSdkVersion and other defaults
      project.ext.javaVersion = JavaVersion.VERSION_17
      
      project.android {
        compileOptions {
          sourceCompatibility = JavaVersion.VERSION_17
          targetCompatibility = JavaVersion.VERSION_17
        }
      }
    }
  }
  
  afterEvaluate {
    // Force Java compilation to VERSION_17
    if (project.hasProperty('android')) {
      project.android.compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
      }
    }

    // Override JavaCompile tasks - MUST happen after evaluation
    project.tasks.all { task ->
      if (task instanceof JavaCompile) {
        task.sourceCompatibility = '17'
        task.targetCompatibility = '17'
        task.options.release.set(17)
        println "JavaCompile for ${project.name}: forced to Java 11"
      }
    }

    // Override KotlinCompile tasks - MUST happen after evaluation
    project.tasks.all { task ->
      if (task.class.simpleName == 'KotlinCompile' || task.class.name.contains('KotlinCompile')) {
        task.kotlinOptions.jvmTarget = '17'
        println "KotlinCompile for ${project.name}: forced to jvmTarget 11"
      }
    }
  }
}

// ========== JVM TOOLCHAIN ENFORCEMENT (Gradle 6.7+) ==========
// This ensures Java compilation uses JVM 11 consistently
plugins.withId('java') {
  project.extensions.configure(JavaPluginExtension) { ext ->
    ext.toolchain {
      languageVersion = JavaLanguageVersion.of(17)
    }
  }
}

allprojects {
  plugins.withId('org.jetbrains.kotlin.jvm') {
    kotlin {
      jvmToolchain(17)
    }
  }
}
